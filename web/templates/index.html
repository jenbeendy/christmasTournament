<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vánoční golfový turnaj</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div id="app">
        <header v-if="view !== 'landing'" style="text-align: center; background: white; border-bottom: 1px solid #eee;">
            <h1 style="margin: 0; padding: 20px 0;">Vánoční turnaj</h1>
            <nav v-if="view === 'admin'">
                <button @click="adminTab = 'players'" :class="{active: adminTab === 'players'}">Hráči</button>
                <button @click="adminTab = 'flights'" :class="{active: adminTab === 'flights'}">Flighty</button>
                <button @click="adminTab = 'results'" :class="{active: adminTab === 'results'}">Výsledky</button>
                <button @click="adminTab = 'course'" :class="{active: adminTab === 'course'}">Hřiště</button>
                <button @click="adminTab = 'flights-qr'" :class="{active: adminTab === 'flights-qr'}">QR kódy</button>
            </nav>
        </header>

        <main>
            <!-- Landing View -->
            <div v-if="view === 'landing'" class="landing-view">
                <div class="landing-content">
                    <img src="/static/img/logo_black.png" alt="Logo" class="landing-logo">
                    <h1>Vánoční turnaj</h1>
                </div>
            </div>

            <!-- Admin View -->
            <div v-if="view === 'admin'" class="admin-panel">
                <!-- Players Tab -->
                <div v-if="adminTab === 'players'">
                    <h2>Hráči</h2>
                    <div class="actions">
                        <div class="player-form">
                            <h3>{{ isEditing ? 'Upravit hráče' : 'Přidat hráče' }}</h3>
                            <input v-model="playerForm.name" placeholder="Jméno">
                            <input v-model="playerForm.surname" placeholder="Příjmení">
                            <input v-model="playerForm.reg_num" placeholder="Reg. č.">
                            <input v-model.number="playerForm.handicap" type="number" step="0.1" placeholder="HCP">
                            <select v-model="playerForm.gender">
                                <option value="M">Muž</option>
                                <option value="F">Žena</option>
                            </select>
                            <button @click="savePlayer">{{ isEditing ? 'Uložit' : 'Přidat' }}</button>
                            <button v-if="isEditing" @click="cancelEdit">Zrušit</button>
                        </div>
                        <hr>
                        <label>Importovat CSV: </label>
                        <input type="file" @change="uploadPlayers" accept=".csv">
                        <div style="margin-top: 15px;">
                            <button @click="fetchHCPs" :disabled="isFetchingHCP"
                                style="background: #1b4d3e; color: white;">Načíst chybějící HCP</button>
                            <span v-if="isFetchingHCP" style="margin-left: 10px; font-style: italic;">Načítám
                                handicapy... může to chvíli trvat.</span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Jméno</th>
                                <th>Příjmení</th>
                                <th>Reg. č.</th>
                                <th>HCP</th>
                                <th>Pohlaví</th>
                                <th>Akce</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="player in players" :key="player.id">
                                <td>{{ player.name }}</td>
                                <td>{{ player.surname }}</td>
                                <td>{{ player.reg_num }}</td>
                                <td>{{ player.handicap }}</td>
                                <td>{{ player.gender === 'F' ? 'Žena' : 'Muž' }}</td>
                                <td>
                                    <button @click="editPlayer(player)">Upravit</button>
                                    <button @click="deletePlayer(player.id)">Smazat</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Flights Tab -->
                <div v-if="adminTab === 'flights'">
                    <h2>Flighty</h2>
                    <div class="create-flight" style="margin-bottom: 20px;">
                        <input v-model="newFlightName" placeholder="Název flightu">
                        <label style="margin-left: 10px;">Startovní jamka: </label>
                        <select v-model="newFlightStartingHole">
                            <option v-for="h in 18" :key="h" :value="h">{{ h }}</option>
                        </select>
                        <button @click="createFlight" style="margin-left: 10px;">Vytvořit flight</button>
                    </div>

                    <div class="flights-container">
                        <div class="flight-column">
                            <h3>Nepřiřazení</h3>
                            <div id="unassigned-players" class="player-list">
                                <div v-for="player in unassignedPlayers" :key="player.id" :data-id="player.id"
                                    class="player-card">
                                    {{ player.name }} {{ player.surname }}
                                </div>
                            </div>
                        </div>

                        <div class="flight-column" v-for="flight in flights" :key="flight.id">
                            <h3>
                                <input v-model="flight.name" @change="updateFlight(flight)"
                                    style="width: 100px; font-weight: bold; border: none; background: transparent;">
                                <select v-model="flight.starting_hole" @change="updateFlight(flight)"
                                    style="font-size: 0.8em; margin-left: 5px;">
                                    <option v-for="h in 18" :key="h" :value="h">Jamka {{ h }}</option>
                                </select>
                                <button @click="deleteFlight(flight.id)"
                                    style="float: right; font-size: 0.8em; color: red; border: none; background: transparent; cursor: pointer;">✕</button>
                            </h3>
                            <p style="font-size: 0.8em; color: #666; margin-top: -5px;">Token: {{ flight.token }}</p>
                            <p><a :href="'/?view=scoring&token=' + flight.token" target="_blank">Odkaz na skórování</a>
                            </p>
                            <div :id="'flight-' + flight.id" class="player-list flight-list"
                                :data-flight-id="flight.id">
                                <div v-for="player in flight.players" :key="player.id" :data-id="player.id"
                                    class="player-card">
                                    {{ player.name }} {{ player.surname }} ({{ player.handicap }})
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div v-if="adminTab === 'results'">
                    <h2>Výsledky</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Pořadí</th>
                                <th>Hráč</th>
                                <th>Brutto</th>
                                <th>Netto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(r, index) in results" :key="r.id">
                                <td>{{ index + 1 }}</td>
                                <td>{{ r.name }} {{ r.surname }}</td>
                                <td>{{ r.gross }}</td>
                                <td>{{ r.net.toFixed(1) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Course Tab -->
                <div v-if="adminTab === 'course'">
                    <h2>Konfigurace hřiště</h2>
                    <div class="actions">
                        <button @click="saveCourse">Uložit změny</button>
                        <hr>
                        <div style="margin-top: 10px;">
                            <a href="/api/course/export" class="button-link"
                                style="text-decoration: none; padding: 5px 10px; background: #eee; border: 1px solid #ccc; color: black; border-radius: 4px; font-size: 0.9em;">Exportovat
                                CSV</a>
                            <label style="margin-left: 20px;">Importovat CSV: </label>
                            <input type="file" @change="uploadCourse" accept=".csv">
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Jamka</th>
                                <th>Par</th>
                                <th>Žlutá (m)</th>
                                <th>Červená (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="hole in course" :key="hole.hole_number">
                                <td>{{ hole.hole_number }}</td>
                                <td><input type="number" v-model.number="hole.par" min="3" max="5"></td>
                                <td><input type="number" v-model.number="hole.length_yellow" min="50" max="600"></td>
                                <td><input type="number" v-model.number="hole.length_red" min="50" max="600"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Flights QR Tab -->
                <div v-if="adminTab === 'flights-qr'">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>QR kódy flightů</h2>
                        <button @click="downloadAllQRs"
                            style="background: #1b4d3e; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">Stáhnout
                            vše</button>
                    </div>
                    <div class="qr-grid">
                        <div v-for="flight in flights" :key="flight.id" class="qr-card">
                            <h3>{{ flight.name }}</h3>
                            <div class="qr-info">Startovní jamka: <strong>{{ flight.starting_hole }}</strong></div>
                            <div :id="'qr-' + flight.id" class="qr-container"></div>
                            <div class="qr-url">https://vanoce.jdark.org/?t={{ flight.token }}</div>
                            <div class="qr-token">{{ flight.token }}</div>
                            <button @click="downloadQR(flight)" class="qr-download-btn">Stáhnout PNG</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scoring View -->
            <div v-if="view === 'scoring'" class="scoring-panel">
                <div v-if="!currentFlight" class="flight-entry">
                    <h2>Zadejte token flightu</h2>
                    <input v-model="flightToken" placeholder="Token">
                    <button @click="loadFlight">Načíst flight</button>
                </div>
                <div v-else class="scoring-view">
                    <!-- Removed blue app-header -->


                    <!-- Player Header (Sticky) -->
                    <div class="player-header-container">
                        <div class="hole-header-cell">
                        </div>
                        <div class="player-header-row">
                            <div v-for="player in currentFlight.players" :key="player.id" class="player-header-card">
                                <div class="avatar-circle">{{ getInitials(player.name, player.surname) }}</div>
                                <div class="player-name">{{ player.name }}</div>
                                <div class="player-hcp">HCP: {{ player.handicap }}</div>
                                <div class="active-indicator"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Scoring Grid -->
                    <div class="scoring-grid">
                        <!-- Holes 1-9 -->
                        <div v-for="hole in 9" :key="hole" class="hole-row"
                            :class="{ 'starting-hole-row': hole === currentFlight?.starting_hole && !isHoleScored(hole) }">
                            <div class="hole-info-cell">
                                <div class="hole-number"># {{ hole }}</div>
                                <div class="hole-par">PAR {{ getPar(hole) }}</div>
                            </div>
                            <div v-for="player in currentFlight.players" :key="player.id" class="score-cell-wrapper"
                                @click="openPicker(hole)">
                                <div class="score-msg-box" :style="getScoreStyle(getScore(player.id, hole), hole)">
                                    <div class="dist-text" style="color: black;">
                                        {{ getDistance(hole, player) }}m
                                    </div>
                                    <div class="score-val">
                                        {{ getScore(player.id, hole) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary 1-9 -->
                        <div class="hole-row summary-row">
                            <div class="hole-info-cell">
                                Rány<br>1-9
                            </div>
                            <div v-for="player in currentFlight.players" :key="player.id"
                                class="score-cell-wrapper summary-cell">
                                {{ getPlayerTotal(player.id, 1, 9) }}
                            </div>
                        </div>

                        <!-- Holes 10-18 -->
                        <div v-for="hole in 9" :key="hole + 9" class="hole-row"
                            :class="{ 'starting-hole-row': (hole + 9) === currentFlight?.starting_hole && !isHoleScored(hole + 9) }">
                            <div class="hole-info-cell">
                                <div class="hole-number"># {{ hole + 9 }}</div>
                                <div class="hole-par">PAR {{ getPar(hole + 9) }}</div>
                            </div>
                            <div v-for="player in currentFlight.players" :key="player.id" class="score-cell-wrapper"
                                @click="openPicker(hole + 9)">
                                <div class="score-msg-box"
                                    :style="getScoreStyle(getScore(player.id, hole + 9), hole + 9)">
                                    <div class="dist-text" style="color: black;">
                                        {{ getDistance(hole + 9, player) }}m
                                    </div>
                                    <div class="score-val">
                                        {{ getScore(player.id, hole + 9) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary 10-18 -->
                        <div class="hole-row summary-row">
                            <div class="hole-info-cell">
                                Rány<br>10-18
                            </div>
                            <div v-for="player in currentFlight.players" :key="player.id"
                                class="score-cell-wrapper summary-cell">
                                {{ getPlayerTotal(player.id, 10, 18) }}
                            </div>
                        </div>

                        <!-- Total 1-18 -->
                        <div class="hole-row summary-row total-row">
                            <div class="hole-info-cell">
                                Celkem<br>1-18
                            </div>
                            <div v-for="player in currentFlight.players" :key="player.id"
                                class="score-cell-wrapper summary-cell">
                                {{ getPlayerTotal(player.id, 1, 18) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Number Picker Modal -->
                <div v-if="showPicker" class="picker-modal" @click.self="closePicker">
                    <div class="picker-content">
                        <div class="picker-header">
                            <button @click="closePicker">Zrušit</button>
                            <div class="picker-title-group">
                                <div class="picker-title">Jamka č. {{ pickerHole }}</div>
                                <div class="picker-subtitle">PAR {{ getPar(pickerHole) }}</div>
                            </div>
                            <button @click="confirmScore" class="confirm-text">Potvrdit</button>
                        </div>
                        <div class="multi-picker-layout">
                            <div v-for="player in currentFlight.players" :key="player.id" class="player-picker-col">
                                <div class="player-picker-name">{{ getInitials(player.name, player.surname) }}</div>
                                <div class="picker-wheel-container">
                                    <div class="picker-highlight"></div>
                                    <div class="picker-list" :ref="el => setPickerRef(player.id, el)"
                                        @scroll="onPlayerScroll(player.id, $event)">
                                        <div v-for="n in 12" :key="n-1" class="picker-item"
                                            :class="{selected: pickerValues[player.id] === (n-1)}"
                                            @click="scrollToPlayerValue(player.id, n-1)">
                                            {{ n-1 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warning Modal -->
                <div v-if="showWarning" class="picker-modal" @click.self="closeWarning">
                    <div class="picker-content"
                        style="max-width: 320px; align-self: center; margin-bottom: 0; border-radius: 16px;">
                        <div class="picker-header" style="justify-content: center;">
                            <div class="picker-title">Upozornění</div>
                        </div>
                        <div
                            style="padding: 24px; text-align: center; color: #333; line-height: 1.5; font-size: 0.95em;">
                            {{ warningMessage }}
                        </div>
                        <div style="padding: 16px; border-top: 1px solid #eee; text-align: center;">
                            <button @click="closeWarning"
                                style="background: none; border: none; color: #007aff; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%;">Rozumím</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="/static/js/app.js"></script>
</body>

</html>